# æ–°å·¥å…·éƒ¨ç½²å·¥ä½œæµæ¨¡æ¿
#
# ä½¿ç”¨æ–¹æ³•ï¼š
# 1. å¤åˆ¶æ­¤æ–‡ä»¶åˆ° .github/workflows/ ç›®å½•
# 2. é‡å‘½åä¸º deploy-ä½ çš„å·¥å…·å.yml
# 3. ä¿®æ”¹ä¸‹é¢æ ‡æ³¨ [ä¿®æ”¹] çš„åœ°æ–¹
#
# éƒ¨ç½²åŽçš„è®¿é—®åœ°å€ï¼šhttps://ä½ çš„é¡¹ç›®å.pages.dev

name: éƒ¨ç½² [å·¥å…·åç§°] åˆ° Cloudflare Pages  # [ä¿®æ”¹] æ”¹æˆä½ çš„å·¥å…·åç§°

on:
  push:
    branches:
      - main
      - master
    paths:
      - '[ä½ çš„å·¥å…·æ–‡ä»¶å¤¹å]/**'           # [ä¿®æ”¹] æ”¹æˆä½ çš„å·¥å…·æ–‡ä»¶å¤¹å
      - '.github/workflows/deploy-[ä½ çš„å·¥å…·å].yml'  # [ä¿®æ”¹] æ”¹æˆè¿™ä¸ªæ–‡ä»¶çš„åç§°
  pull_request:
    branches:
      - main
      - master
    paths:
      - '[ä½ çš„å·¥å…·æ–‡ä»¶å¤¹å]/**'           # [ä¿®æ”¹] åŒä¸Š
      - '.github/workflows/deploy-[ä½ çš„å·¥å…·å].yml'  # [ä¿®æ”¹] åŒä¸Š
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  WORK_DIR: ./[ä½ çš„å·¥å…·æ–‡ä»¶å¤¹å]          # [ä¿®æ”¹] æ”¹æˆä½ çš„å·¥å…·æ–‡ä»¶å¤¹å

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write

    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.jsçŽ¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ${{ env.WORK_DIR }}/package-lock.json

      - name: å®‰è£…ä¾èµ–
        working-directory: ${{ env.WORK_DIR }}
        run: npm ci

      # å¦‚æžœä½ çš„å·¥å…·éœ€è¦ä¸‹è½½é¢å¤–èµ„æºï¼Œå–æ¶ˆä¸‹é¢çš„æ³¨é‡Š
      # - name: ä¸‹è½½èµ„æºæ–‡ä»¶
      #   working-directory: ${{ env.WORK_DIR }}
      #   run: npm run download-resources

      - name: æž„å»ºåº”ç”¨
        working-directory: ${{ env.WORK_DIR }}
        run: npm run build

      - name: å®‰è£…Wrangler
        run: npm install -g wrangler

      - name: åˆ›å»ºCloudflare Pagesé¡¹ç›®ï¼ˆå¦‚ä¸å­˜åœ¨ï¼‰
        run: wrangler pages project create [ä½ çš„é¡¹ç›®å] --production-branch=main || true  # [ä¿®æ”¹] æ”¹æˆé¡¹ç›®å
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: éƒ¨ç½²åˆ°Cloudflare Pages
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy ${{ env.WORK_DIR }}/dist --project-name=[ä½ çš„é¡¹ç›®å] --commit-dirty=true  # [ä¿®æ”¹] æ”¹æˆé¡¹ç›®å

      - name: âœ… éƒ¨ç½²å®Œæˆ
        run: |
          echo "## ðŸŽ‰ éƒ¨ç½²æˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ç”Ÿäº§çŽ¯å¢ƒç½‘å€: https://[ä½ çš„é¡¹ç›®å].pages.dev" >> $GITHUB_STEP_SUMMARY  # [ä¿®æ”¹] æ”¹æˆé¡¹ç›®å
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "é¡¹ç›®: [ä½ çš„é¡¹ç›®å]" >> $GITHUB_STEP_SUMMARY  # [ä¿®æ”¹] æ”¹æˆé¡¹ç›®å
          echo "éƒ¨ç½²æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
